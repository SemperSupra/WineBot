#!/usr/bin/env bash
set -euo pipefail

# WineBot Unified Lifecycle Entrypoint
# Inspired by supragoflow './scripts/gg'

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"
PROFILE_CATALOG="$REPO_ROOT/scripts/internal/profile-catalog.sh"
if [ -f "$PROFILE_CATALOG" ]; then
    # shellcheck source=scripts/internal/profile-catalog.sh
    source "$PROFILE_CATALOG"
else
    echo "ERROR: missing profile catalog: $PROFILE_CATALOG" >&2
    exit 1
fi

usage() {
    cat <<EOF
WineBot Lifecycle Manager

Usage:
  ./scripts/wb <command> [args]

Commands:
  bootstrap   Check and initialize development environment
  lint        Run containerized linting (Ruff, Mypy)
  test        Run containerized unit/integration tests
  smoke-test  Run containerized end-to-end smoke tests
  build       Build WineBot container images
  profile     Start a named default runtime profile
  feature-map Generate auto draft feature/capability commit map
  vuln        Run vulnerability scan on dependencies/images
  ctl         Proxy to winebotctl (API control)
  help        Show this help

Global Options:
  WINEBOT_ENV  Environment file to load (default: .env)
EOF
}

log() {
    echo ">> [wb] $*"
}

# 1. Bootstrap
bootstrap() {
    log "Checking dependencies..."
    command -v docker >/dev/null 2>&1 || { echo "ERROR: docker not found"; exit 1; }
    command -v docker-compose >/dev/null 2>&1 || docker compose version >/dev/null 2>&1 || { echo "ERROR: docker compose not found"; exit 1; }
    log "Environment ready."
}

# 2. Lint
lint() {
    log "Running linting suite..."
    docker compose -f "$REPO_ROOT/compose/docker-compose.yml" --profile lint run --rm lint-runner
}

# 3. Test
test_suite() {
    log "Running tests..."
    docker compose -f "$REPO_ROOT/compose/docker-compose.yml" --profile test --profile interactive run --rm test-runner
}

# 4. Smoke Test
smoke_test() {
    log "Running smoke tests..."
    # Build 'test' intent if it doesn't exist
    docker compose -f "$REPO_ROOT/compose/docker-compose.yml" build winebot
    "$REPO_ROOT/scripts/bin/smoke-test.sh" --no-build
}

# 5. Build
build() {
    intent="${1:-rel}"
    log "Building image (intent: $intent)..."
    BUILD_INTENT="$intent" docker compose -f "$REPO_ROOT/compose/docker-compose.yml" build winebot
}

# 6. Vuln (Trivy)
vuln() {
    log "Running vulnerability scan..."
    if command -v trivy >/dev/null 2>&1; then
        trivy fs .
    else
        log "trivy not found on host, running via docker..."
        docker run --rm -v "$REPO_ROOT:/work" -w /work aquasec/trivy fs .
    fi
}

profile() {
    sub="${1:-list}"
    shift || true
    case "$sub" in
        list)
            local use_cases
            local perf_profiles
            local aliases
            use_cases="$(wb_profile_use_case_names)"
            perf_profiles="$(wb_profile_performance_names)"
            aliases="$(wb_profile_legacy_aliases)"
            cat <<EOF
Use-case startup profiles:
$(printf '%s\n' "$use_cases" | sed 's/^/  /')

Performance profiles:
$(printf '%s\n' "$perf_profiles" | sed 's/^/  /')

Legacy aliases:
$(printf '%s\n' "$aliases" | sed 's/^/  /')

Usage:
  ./scripts/wb profile up <use-case> [--performance <name>] [--build] [--detach] [--dry-run]
EOF
            ;;
        up)
            local use_case
            local performance
            local resolved
            local mode
            use_case="${1:-}"
            shift || true
            [ -n "$use_case" ] || { echo "ERROR: use-case profile name required"; exit 1; }

            build_flag=""
            detach_flag=""
            dry_run="0"
            performance=""
            while [ $# -gt 0 ]; do
                case "$1" in
                    --performance)
                        performance="${2:-}"
                        [ -n "$performance" ] || { echo "ERROR: --performance requires a value"; exit 1; }
                        shift 2
                        ;;
                    --build) build_flag="--build"; shift ;;
                    --detach) detach_flag="-d"; shift ;;
                    --dry-run) dry_run="1"; shift ;;
                    *) echo "ERROR: Unknown profile option: $1"; exit 1 ;;
                esac
            done

            compose_profile=""
            service=""
            env_vars=()
            if ! resolved="$(wb_profile_render_values "$use_case" "$performance")"; then
                echo "ERROR: invalid profile selection use_case='$use_case' performance='${performance:-<default>}'" >&2
                exit 1
            fi
            while IFS='=' read -r key value; do
                [ -n "$key" ] || continue
                env_vars+=("$key=$value")
                if [ "$key" = "MODE" ]; then
                    mode="$value"
                fi
            done <<< "$resolved"

            if [ "${mode:-}" = "interactive" ]; then
                compose_profile="interactive"
                service="winebot-interactive"
            else
                compose_profile="headless"
                service="winebot"
            fi

            if [ "$dry_run" = "1" ]; then
                log "Dry-run resolved use-case '$use_case' (performance: ${performance:-default}, compose profile: $compose_profile, service: $service)"
                printf '%s\n' "$resolved"
                return 0
            fi

            log "Starting use-case '$use_case' (performance: ${performance:-default}, compose profile: $compose_profile, service: $service)..."
            env "${env_vars[@]}" docker compose -f "$REPO_ROOT/compose/docker-compose.yml" --profile "$compose_profile" up --force-recreate $build_flag $detach_flag "$service"
            ;;
        *)
            echo "ERROR: Unknown profile command: $sub"
            exit 1
            ;;
    esac
}

feature_map() {
    local limit="${1:-200}"
    log "Generating feature/capability commit map draft (limit: ${limit})..."
    python3 "$REPO_ROOT/scripts/internal/generate-feature-commit-map.py" --limit "$limit"
}

# 7. winebotctl Proxy
ctl() {
    "$REPO_ROOT/scripts/bin/winebotctl" "$@"
}

command="${1:-help}"
shift || true

case "$command" in
    bootstrap)  bootstrap ;;
    lint)       lint ;;
    test)       test_suite ;;
    smoke-test) smoke_test ;;
    build)      build "$@" ;;
    profile)    profile "$@" ;;
    feature-map) feature_map "$@" ;;
    vuln)       vuln ;;
    ctl)        ctl "$@" ;;
    help|--help|-h) usage ;;
    *)          log "Unknown command: $command"; usage; exit 1 ;;
esac
